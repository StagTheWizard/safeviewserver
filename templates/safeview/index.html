<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Safeview</title>

    {% load static %}
    <script language="JavaScript" type="text/javascript" src="https://d3js.org/d3.v3.min.js"></script>
    <script language="JavaScript" type="text/javascript"
            src="{% static "safeviewservice/scripts/d3.tip.v0.6.3.js" %}"></script>
    <script language="JavaScript" type="text/javascript"
            src="{% static "safeviewservice/scripts/helper.js" %}"></script>
    <script language="JavaScript" type="text/javascript"
            src="{% static "safeviewservice/scripts/jquery-1.12.0.min.js" %}"></script>
    <script language="JavaScript" type="text/javascript"
            src="{% static "safeviewservice/scripts/qv1.min.js" %}"></script>
    <script language="JavaScript" type="text/javascript"
            src="{% static "safeviewservice/scripts/harm-graph.js" %}"></script>

    <style>
        p {
            font-family: "Helvetica Neue", sans-serif;
            font-size: 10pt;
        }

        label {
            font-family: "Helvetica Neue", sans-serif;
            font-size: 10pt;
        }

        button {
            font-family: "Helvetica Neue", sans-serif;
            font-size: 9pt;
        }

        select {
            font-family: "Helvetica Neue", sans-serif;
            font-size: 10pt;
        }

        option {
            font-family: "Helvetica Neue", sans-serif;
            font-size: 9pt;
        }

        input {
            font-family: "Helvetica Neue", sans-serif;
            font-size: 10pt;
        }

        #banner {
            height: 100px;
            border: 1px solid #000;
            margin: 0 0 5px 0;
        }

        #banner-title {
            padding-left: 20px;
        }

        .container {
            position: relative;
            padding: 0 0 0 260px;
        }

        #sidebar {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            border: 1px solid #000;
            width: 250px;
        }

        .sidebar-group {
            border: 1px solid #000;
            padding: 2px 2px 2px 2px;
            margin: 1px 1px 1px 1px;
        }

        #system-choice {
            width: 100%;
        }

        #upload-choice {
            width: 100%;
        }

        .sidebar-button {
            width: 100%;
            text-align: left;
            border: 0;
        }

        #header {
            border: 1px solid #000;
            height: 100px;
            margin: 0 0 5px 0;
        }

        #content {
            border: 1px solid #000;
            margin: 5px 0 5px 0;
        }

        #footer {
            border: 1px solid #000;
            height: 100px;
            margin: 5px 0 0 0;
        }

        #harm-upper {
            padding: 10px;
        {#            background-color: rgb(46, 46, 50);#}
        }

        #harm-lower {
            padding: 10px;
        }

        .node {
            font-family: "Helvetica Neue", sans-serif;
            font-size: 8pt;
            color: #222;
        {#            stroke: #fff;#}{#            stroke: rgb(46, 46, 50);#}{#            stroke-width: 1px;#}
        }

        circle {
        {#            stroke: rgb(46, 46, 50);#} stroke: #fff;
            stroke-width: 2px;
        }

        .link {
            stroke: #999;
            stroke-opacity: .6;
        }

        div.tooltip {
            position: absolute;
            text-align: center;
            height: 28px;
            padding: 2px;
            font: 12px sans-serif;
            background: #DDD;
            border: 0px;
            border-radius: 4px;
            pointer-events: none;
        }

        #query-div {
            padding-top: 10px;
            padding-left: 20px;
        }
    </style>

</head>


<body>

<div id="banner">
    <p id="banner-title">Safelite Network Security Visualisation</p>
</div>


<div class="container">


    <div id="sidebar">
        <div id="system-management">
            <div class="sidebar-group">
                <label for="system-choice">System</label>
                <select id="system-choice" name="system-choice" onchange="on_system_selected()"></select>
                <br>
                <button class="sidebar-button" onclick="add_system_prompt()">Add</button>
                <br>
                <button class="sidebar-button" onclick="del_system_prompt()">Delete</button>
            </div>

            <div class="sidebar-group">
                <label for="harm-choice">Harm</label>
                <select id="harm-choice" name="harm-choice" onchange="on_harm_selected()"></select>
                <br>
                <button class="sidebar-button" onclick="on_harm_selected()">Display</button>
            </div>

            <div class="sidebar-group">
                <form id="upload-form" action="" method="post" enctype="multipart/form-data">
                    <label for="upload-choice">Upload to</label>
                    <select id="upload-choice" name="upload-choice"></select>
                    <input type="file" name="upload-file" id="upload-file" value="Choose File">
                    <br>
                    <input type="submit" name="submit" class="sidebar-button" value="Upload">
                </form>
            </div>
        </div>

        <div id="query-management" class="sidebar-group">
            <label for="harm-query">Query host names:</label>
            <input id="harm-query" type="text" onchange="on_query_changes(this.value)">
        </div>
    </div>


    <div id="header">

    </div>


    <div id="content">
        <div id="harm-upper" align="center">

        </div>

        <div id="harm-lower" align="center">

        </div>
    </div>


    <div id="footer">

    </div>
</div>


<script language="JavaScript">
    var $content = $("#content");
    var upper_width = $content.width() - 40, upper_height = 600;
    var lower_width = $content.width() - 40, lower_height = 600;

    var harm_graph;


    // TODO: Should it be really be initially hidden?
    $("#harm-lower").hide();


    function keys(dictionary) {
        var keys = [];
        for (var key in dictionary) {
            if (dictionary.hasOwnProperty(key)) {
                keys.push(key);
            }
        }
        return keys;
    }


    function request_systems() {
        // Check if the systems ids have been loaded already (not undefined).
        if (sessionStorage["systems"] != null && JSON.parse(sessionStorage["systems"]) != null) {
            return new Promise(function (resolve, reject) {
                resolve(JSON.parse(sessionStorage["systems"]));
            });
        }
        // Otherwise, create dictionary of system ids to nulls (unloaded data).
        sessionStorage["systems"] = JSON.stringify({});
        return new Promise(function (resolve, reject) {
            $.ajax({
                dataType: "json",
                url: "/safeview/systems/",
                success: function (system_ids, text_status, xhr) {
                    // Returns a list of system ids.
                    // Store each system id in the systems dictionary in local storage, mapped to a null to signify the
                    // system hasn't been requested from the server yet.
                    var systems = JSON.parse(sessionStorage["systems"]);
                    var system_id;
                    for (var i = 0; i < system_ids.length; i++) {
                        system_id = system_ids[i];
                        systems[system_id] = null;
                    }
                    // Store the processed results.
                    sessionStorage["systems"] = JSON.stringify(systems);
                    // Resolve.
                    resolve(systems);
                }
            });
        });
    }


    function request_system(system_id) {
        return new Promise(function (resolve, reject) {
            request_systems().then(function (systems) {
                // Check if the system has already been loaded (not null).
                if (systems[system_id] != null) {
                    resolve(systems[system_id]);
                }
                // Otherwise, create dictionary of snapshot/harm ids to nulls (unloaded harms).
                systems[system_id] = {};
                $.ajax({
                    dataType: "json",
                    url: "/safeview/systems/" + system_id + "/",
                    success: function (snapshot_ids, text_status, xhr) {
                        // Returns a list of harm ids.
                        // Store each harm id in this systems dictionary, each mapped to a null to signify that the harm
                        // has not been requested from the server yet.
                        var harm_id;
                        for (var i = 0; i < snapshot_ids.length; i++) {
                            harm_id = snapshot_ids[i];
                            systems[system_id][harm_id] = null;
                        }
                        // Store the processed results.
                        sessionStorage["systems"] = JSON.stringify(systems);
                        // Resolve.
                        resolve(systems[system_id]);
                    }
                });
            });
        });
    }


    function request_harm(system_id, harm_id) {
        return new Promise(function (resolve, reject) {
            request_system(system_id).then(function (system) {
                var systems = JSON.parse(sessionStorage["systems"]);
                // Check if the harm has already been loaded (not null).
                if (systems[system_id][harm_id] != null) {
                    resolve(systems[system_id][harm_id]);
                }
                $.ajax({
                    dataType: "json",
                    url: "/safeview/harms/" + system_id + "/" + harm_id + "/",
                    success: function (harm, text_status, xhr) {
                        // Returns a harm (big ol' dictionary).
                        // Update session storage.
                        var systems = JSON.parse(sessionStorage["systems"]);
                        systems[system_id][harm_id] = harm;
                        sessionStorage["systems"] = JSON.stringify(systems);
                        // Resolve.
                        resolve(systems[system_id][harm_id]);
                    }
                });
            });
        });
    }


    function populate_system_ids() {
        return new Promise(function (resolve, reject) {
            request_systems().then(function (systems) {
                var system_ids = keys(systems);
                var system_id;
                for (var i = 0; i < system_ids.length; i++) {
                    system_id = system_ids[i];
                    // Add the system id option to the system choice selector.
                    $("#system-choice").append($("<option></option>").val(system_id).text(system_id));
                    // Add the system id option to the upload to system selector.
                    $("#upload-choice").append($("<option></option>").val(system_id).text(system_id));
                }
                resolve();
            })
        });
    }


    function populate_harm_ids(system_id) {
        return new Promise(function (resolve, reject) {
            request_system(system_id).then(function (system) {
                var $harm_choice = $("#harm-choice");
                // Drop the existing options.
                $harm_choice.find("option").remove();

                var harm_ids = keys(system);
                var harm_id;
                for (var i = 0; i < harm_ids.length; i++) {
                    // Add the harm id option to the harm choice selector.
                    harm_id = harm_ids[i];
                    $harm_choice.append($("<option></option>").val(harm_id).text(harm_id));
                }
                resolve();
            });
        });
    }


    function on_system_selected() {
        return new Promise(function (resolve, reject) {
            var system_id = $("#system-choice").find("option:selected").text();
            populate_harm_ids(system_id).then(resolve);
        });
    }


    function on_harm_selected() {
        return new Promise(function (resolve, reject) {
            var system_id = $("#system-choice").find("option:selected").text();
            var harm_id = $("#harm-choice").find("option:selected").text();
            request_harm(system_id, harm_id).then(function (harm) {
                // Remove he old harm.
                $("#harm-upper").find("svg").remove();

                var d3$upper_svg = d3.select("#harm-upper")
                        .append("svg")
                        .attr("height", upper_height)
                        .attr("width", upper_width);

                //harm_upper(harm, upper_svg, upper_width, upper_height, -300, on_node_clicked);
                harm_graph = new HarmGraph(d3$upper_svg, upper_width, upper_height);
                harm_graph.addEntireHarm(harm);
                harm_graph.initialise();
                //harm_graph.addEntireHarm(harm);
                console.log(harm_graph);

                resolve();
            });
        });
    }


    function on_query_changes(query) {
        console.log("changed '" + query + "'");
        var d3$nodes = d3.selectAll(".node");
        d3$nodes.attr("opacity", 0.3);
        d3$nodes.filter(function (node) {
            return node.name.includes(query);
        }).attr("opacity", 1);

        var d3$links = d3.selectAll(".link");
        d3$links.attr("opacity", 0.3);
        d3$links.filter(function (link) {
            return link.source.name.includes(query) && link.target.name.includes(query);
        })
    }


    /**
     * @deprecated
     * @param node
     */
    function on_node_clicked(node) {
        // wtf is this ..
        //$("#harm-lower").dialog();
        // .. and wtf is this?
        //$("#harm-lower").css('z-index', 9999);

        // Drop old lower.
        var lower_harm_container = $("#harm-lower");
        lower_harm_container.remove("svg");
        var lower_svg = lower_harm_container.append(
                $("<svg></svg>").attr("height", lower_height).attr("width", lower_width));
        harm_lower(node, node, lower_svg, lower_height, lower_width);
    }


    // Initialise the system selector.
    populate_system_ids().then(function () {
        // ... and then the harm selector.
        var system_id = $("#system-choice").find("option:selected").text();
        if (system_id !== null) {
            populate_harm_ids(system_id).then(on_harm_selected);
        }
    });

</script>
</body>
</html>